name: Publish Windows Agent

on:
  push:
    branches: [main]
    paths:
      - "apps/windows-agent/**"
      - ".github/workflows/publish-windows-agent.yml"

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: apps/windows-agent
        run: npm install

      - name: Build TypeScript
        working-directory: apps/windows-agent
        run: npm run build

      - name: Verify dist output exists
        working-directory: apps/windows-agent
        shell: powershell
        run: |
          if (!(Test-Path 'dist/index.js')) {
            Write-Error 'dist/index.js not found - TypeScript build failed'
            exit 1
          }
          Write-Host 'dist/index.js found, proceeding with packaging'

      - name: Create installer staging directory
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "installer" | Out-Null
          Write-Host "installer/ directory created"

      - name: Download Node.js runtime
        shell: powershell
        run: |
          $nodeVersion = "v20.19.0"
          $nodeUrl = "https://nodejs.org/dist/$nodeVersion/node-v20.19.0-win-x64.zip"
          Write-Host "Downloading Node.js $nodeVersion..."
          Invoke-WebRequest -Uri $nodeUrl -OutFile "node-win.zip"
          Write-Host "Extracting..."
          Expand-Archive "node-win.zip" -DestinationPath "node-extracted" -Force
          $nodePath = "node-extracted\node-v20.19.0-win-x64\node.exe"
          if (!(Test-Path $nodePath)) {
            Write-Error "node.exe not found at expected path: $nodePath"
            Get-ChildItem "node-extracted" -Recurse -Filter "node.exe" | Select-Object FullName
            exit 1
          }
          Copy-Item $nodePath -Destination "installer\node.exe"
          Write-Host "node.exe copied to installer/"

      - name: Copy dist and node_modules to installer
        shell: powershell
        run: |
          # Copy compiled JS output
          New-Item -ItemType Directory -Force -Path "installer\dist" | Out-Null
          Copy-Item -Recurse "apps\windows-agent\dist\*" -Destination "installer\dist\"
          Write-Host "dist/ copied"

          # Copy node_modules (includes Sharp with native binaries)
          New-Item -ItemType Directory -Force -Path "installer\node_modules" | Out-Null
          Copy-Item -Recurse "apps\windows-agent\node_modules\*" -Destination "installer\node_modules\"
          Write-Host "node_modules/ copied"

          # Copy package.json (needed for Node module resolution)
          Copy-Item "apps\windows-agent\package.json" -Destination "installer\package.json"
          Write-Host "package.json copied"

      - name: Create launcher script
        shell: bash
        run: |
          cat > installer/popdam-launcher.bat << 'BAT_EOF'
          @echo off
          REM PopDAM Windows Agent Launcher
          REM Ensures drive mapping exists before starting the agent.

          set "CONFIG_DIR=%ProgramData%\PopDAM"
          set "CONFIG_FILE=%CONFIG_DIR%\agent-config.json"
          set "LOG_DIR=%CONFIG_DIR%\logs"

          if not exist "%LOG_DIR%" mkdir "%LOG_DIR%"

          REM --- Drive mapping from agent-config.json ---
          REM Parse drive_letter and nas_unc from config using PowerShell one-liner
          for /f "usebackq delims=" %%D in (`powershell -NoProfile -Command "try { $c = Get-Content '%CONFIG_FILE%' -Raw | ConvertFrom-Json; if ($c.drive_letter -and $c.nas_unc) { Write-Output ('{0}:|{1}' -f $c.drive_letter, $c.nas_unc) } } catch {}"`) do (
              for /f "tokens=1,2 delims=|" %%A in ("%%D") do (
                  if not exist "%%A\" (
                      echo [launcher] Mapping %%A to %%B ...
                      net use %%A %%B /persistent:yes 2>>"%LOG_DIR%\drive-map.log"
                      if errorlevel 1 (
                          echo [launcher] WARNING: Drive mapping failed. Agent may not find NAS files.
                      ) else (
                          echo [launcher] Drive %%A mapped successfully.
                      )
                  ) else (
                      echo [launcher] Drive %%A already mapped.
                  )
              )
          )

          REM --- Start agent ---
          echo [launcher] Starting PopDAM Windows Agent...
          cd /d "%~dp0"
          "%~dp0node.exe" "%~dp0dist\index.js" >> "%LOG_DIR%\agent.log" 2>> "%LOG_DIR%\agent-error.log"
          BAT_EOF

      - name: Install NSIS
        run: choco install nsis -y --no-progress

      - name: Create NSIS script
        shell: bash
        run: |
          cat > installer/setup.nsi << 'NSIS_EOF'
          !include "MUI2.nsh"
          !include "nsDialogs.nsh"

          Name "PopDAM Windows Render Agent"
          OutFile "popdam-windows-agent-setup.exe"
          InstallDir "$PROGRAMFILES64\PopDAM\WindowsAgent"
          RequestExecutionLevel admin

          ; ── Variables ──
          Var PairingCode
          Var ServerUrl
          Var DriveLetter
          Var NasUNC

          Var ConfigDialog
          Var PairingInput
          Var ServerInput
          Var DriveInput
          Var NasUNCInput

          !insertmacro MUI_PAGE_WELCOME
          !insertmacro MUI_PAGE_DIRECTORY
          Page custom ConfigPageCreate ConfigPageLeave
          !insertmacro MUI_PAGE_INSTFILES
          !define MUI_FINISHPAGE_TEXT "PopDAM Windows Render Agent has been installed.$\r$\n$\r$\nThe agent is registered as a Scheduled Task and will start automatically when you log in. It has been started now.$\r$\n$\r$\nThe agent should appear as Online in PopDAM Settings within 60 seconds.$\r$\n$\r$\nLogs: %ProgramData%\PopDAM\logs\"
          !insertmacro MUI_PAGE_FINISH

          !insertmacro MUI_UNPAGE_CONFIRM
          !insertmacro MUI_UNPAGE_INSTFILES

          !insertmacro MUI_LANGUAGE "English"

          ; ══════════════════════════════════════════════════════
          ; Configuration Page
          ; ══════════════════════════════════════════════════════

          Function ConfigPageCreate
            nsDialogs::Create 1018
            Pop $ConfigDialog

            ${NSD_CreateLabel} 0 0 100% 12u "PopDAM Server URL"
            Pop $0
            ${NSD_CreateText} 0 12u 100% 13u "https://vklanxwmaeqjbwtmnygj.supabase.co"
            Pop $ServerInput

            ${NSD_CreateLabel} 0 30u 100% 12u "Pairing Code (from PopDAM Settings → Windows Agent → Pairing)"
            Pop $0
            ${NSD_CreateText} 0 42u 100% 13u ""
            Pop $PairingInput
            SendMessage $PairingInput ${EM_SETCUEBANNER} 1 "STR:XXXX-XXXX-XXXX-XXXX"

            ${NSD_CreateGroupBox} 0 62u 100% 58u "NAS Drive Mapping (optional)"
            Pop $0

            ${NSD_CreateLabel} 10u 76u 80u 12u "Drive Letter:"
            Pop $0
            ${NSD_CreateText} 94u 74u 24u 13u ""
            Pop $DriveInput
            ${NSD_CreateLabel} 120u 76u 14u 12u ":"
            Pop $0

            ${NSD_CreateLabel} 10u 93u 80u 12u "NAS UNC Path:"
            Pop $0
            ${NSD_CreateText} 94u 91u 200u 13u ""
            Pop $NasUNCInput
            SendMessage $NasUNCInput ${EM_SETCUEBANNER} 1 "STR:\\server\share"

            ${NSD_CreateLabel} 10u 108u 280u 10u "Maps a drive letter so the agent can find design files on the NAS."
            Pop $0

            nsDialogs::Show
          FunctionEnd

          Function ConfigPageLeave
            ${NSD_GetText} $PairingInput $PairingCode
            ${NSD_GetText} $ServerInput $ServerUrl
            ${NSD_GetText} $DriveInput $DriveLetter
            ${NSD_GetText} $NasUNCInput $NasUNC

            StrCmp $PairingCode "" 0 +3
              MessageBox MB_OK|MB_ICONEXCLAMATION "Please enter the pairing code from PopDAM Settings."
              Abort
            StrCmp $ServerUrl "" 0 +3
              MessageBox MB_OK|MB_ICONEXCLAMATION "Server URL is required."
              Abort
          FunctionEnd

          ; ══════════════════════════════════════════════════════
          ; Install Section
          ; ══════════════════════════════════════════════════════

          Section "Install"
            SetShellVarContext all
            ; ── Remove existing scheduled task if reinstalling (ignore if not found) ──
            nsExec::ExecToStack 'schtasks /delete /tn "PopDAM Windows Render Agent" /f'
            Pop $0
            Pop $1
            Sleep 500

            ; ── Remove legacy NSSM service if present (ignore if not found) ──
            nsExec::ExecToStack 'sc query PopDAMWindowsAgent'
            Pop $0
            Pop $1
            StrCmp $0 "0" 0 skip_legacy
              nsExec::ExecToStack 'sc stop PopDAMWindowsAgent'
              Pop $0
              Pop $1
              Sleep 2000
              nsExec::ExecToStack 'sc delete PopDAMWindowsAgent'
              Pop $0
              Pop $1
            skip_legacy:

            ; ── Install program files ──
            SetOutPath "$INSTDIR"
            File "node.exe"
            File "package.json"
            File "popdam-launcher.bat"

            SetOutPath "$INSTDIR\dist"
            File /r "dist\*.*"

            SetOutPath "$INSTDIR\node_modules"
            File /r "node_modules\*.*"

            SetOutPath "$INSTDIR"

            ; ── Write .env (minimal — just for dotenv compat) ──
            FileOpen $0 "$INSTDIR\.env" w
            FileWrite $0 "SUPABASE_URL=$ServerUrl$\r$\n"
            FileWrite $0 "POPDAM_PAIRING_CODE=$PairingCode$\r$\n"
            FileWrite $0 "AGENT_NAME=windows-render-agent$\r$\n"
            FileClose $0

            ; ── Create ProgramData directories ──
            CreateDirectory "$APPDATA\PopDAM"
            CreateDirectory "$APPDATA\PopDAM\logs"

            ; ── Write agent-config.json (persistent across reinstalls) ──
            ; Only write if not already present (preserve existing config on upgrade)
            IfFileExists "$APPDATA\PopDAM\agent-config.json" skip_config
              FileOpen $0 "$APPDATA\PopDAM\agent-config.json" w
              FileWrite $0 '{$\r$\n'
              FileWrite $0 '  "server_url": "$ServerUrl",$\r$\n'
              FileWrite $0 '  "pairing_code": "$PairingCode",$\r$\n'
              FileWrite $0 '  "drive_letter": "$DriveLetter",$\r$\n'
              FileWrite $0 '  "nas_unc": "$NasUNC"$\r$\n'
              FileWrite $0 '}$\r$\n'
              FileClose $0
            skip_config:

            ; ── Verify config file was written ──
            IfFileExists "$APPDATA\PopDAM\agent-config.json" config_ok
              MessageBox MB_OK|MB_ICONSTOP "FATAL: Failed to create agent-config.json in $APPDATA\PopDAM\.$\r$\n$\r$\nCheck that this installer is running as Administrator."
              Abort
            config_ok:

            ; ── Register Scheduled Task (interactive session) ──
            nsExec::ExecToStack 'powershell -NoProfile -ExecutionPolicy Bypass -Command "$$action = New-ScheduledTaskAction -Execute \"$INSTDIR\popdam-launcher.bat\" -WorkingDirectory \"$INSTDIR\"; $$trigger = New-ScheduledTaskTrigger -AtLogOn; $$settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -DontStopOnIdleEnd -RestartCount 3 -RestartInterval (New-TimeSpan -Seconds 60) -ExecutionTimeLimit (New-TimeSpan -Days 0) -StartWhenAvailable -MultipleInstances IgnoreNew; $$principal = New-ScheduledTaskPrincipal -UserId $$env:USERNAME -LogonType Interactive -RunLevel Highest; Register-ScheduledTask -TaskName \"PopDAM Windows Render Agent\" -Action $$action -Trigger $$trigger -Settings $$settings -Principal $$principal -Description \"PopDAM Windows Render Agent\" -Force"'
            Pop $0  ; exit code
            Pop $1  ; output
            StrCmp $0 "0" task_registered
              MessageBox MB_OK|MB_ICONSTOP "FATAL: Failed to register Scheduled Task.$\r$\n$\r$\nExit code: $0$\r$\nOutput: $1"
              Abort
            task_registered:

            ; ── Verify the task actually exists ──
            nsExec::ExecToStack 'schtasks /query /tn "PopDAM Windows Render Agent"'
            Pop $0
            Pop $1
            StrCmp $0 "0" task_verified
              MessageBox MB_OK|MB_ICONSTOP "FATAL: Scheduled Task was not found after registration.$\r$\n$\r$\nschtasks /query exit code: $0$\r$\nOutput: $1"
              Abort
            task_verified:

            ; ── Start the task immediately ──
            nsExec::ExecToStack 'schtasks /run /tn "PopDAM Windows Render Agent"'
            Pop $0
            Pop $1
            StrCmp $0 "0" task_started
              MessageBox MB_OK|MB_ICONEXCLAMATION "WARNING: Task registered but could not be started immediately.$\r$\n$\r$\nExit code: $0$\r$\nOutput: $1$\r$\n$\r$\nThe agent will start at next logon."
            task_started:

            ; ── Start Menu shortcuts ──
            CreateDirectory "$SMPROGRAMS\PopDAM"
            CreateShortcut "$SMPROGRAMS\PopDAM\PopDAM Windows Agent.lnk" "$INSTDIR\popdam-launcher.bat" "" "$INSTDIR\node.exe" 0
            CreateShortcut "$SMPROGRAMS\PopDAM\View Logs.lnk" "$APPDATA\PopDAM\logs"
            CreateShortcut "$SMPROGRAMS\PopDAM\Uninstall Windows Agent.lnk" "$INSTDIR\uninstall.exe"

            ; ── Create uninstaller ──
            WriteUninstaller "$INSTDIR\uninstall.exe"

            ; ── Register in Add/Remove Programs ──
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "DisplayName" "PopDAM Windows Render Agent"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "UninstallString" '"$INSTDIR\uninstall.exe"'
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "QuietUninstallString" '"$INSTDIR\uninstall.exe" /S'
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "InstallLocation" "$INSTDIR"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "DisplayVersion" "2.0.0"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "Publisher" "PopDAM"
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "NoModify" 1
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "NoRepair" 1
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "EstimatedSize" 150000
          SectionEnd

          ; ══════════════════════════════════════════════════════
          ; Uninstall Section
          ; ══════════════════════════════════════════════════════

          Section "Uninstall"
            SetShellVarContext all
            ; Stop and remove the scheduled task
            nsExec::ExecToLog 'schtasks /end /tn "PopDAM Windows Render Agent"'
            Sleep 2000
            nsExec::ExecToLog 'schtasks /delete /tn "PopDAM Windows Render Agent" /f'

            ; Remove legacy NSSM service if still present
            nsExec::ExecToLog 'sc stop PopDAMWindowsAgent'
            nsExec::ExecToLog 'sc delete PopDAMWindowsAgent'

            ; Remove program files
            Delete "$INSTDIR\node.exe"
            Delete "$INSTDIR\package.json"
            Delete "$INSTDIR\popdam-launcher.bat"
            Delete "$INSTDIR\.env"
            Delete "$INSTDIR\uninstall.exe"
            RMDir /r "$INSTDIR\dist"
            RMDir /r "$INSTDIR\node_modules"
            RMDir "$INSTDIR"
            RMDir "$PROGRAMFILES64\PopDAM"

            ; Remove Start Menu
            RMDir /r "$SMPROGRAMS\PopDAM"

            ; Remove registry
            DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent"

            ; Ask about config removal
            MessageBox MB_YESNO "Remove agent configuration and logs from %ProgramData%\PopDAM?$\r$\n$\r$\nSelect 'No' to preserve your agent key and settings for a future reinstall." IDYES remove_config IDNO skip_config_remove
            remove_config:
              RMDir /r "$APPDATA\PopDAM"
            skip_config_remove:
          SectionEnd
          NSIS_EOF

      - name: Build installer
        shell: powershell
        working-directory: installer
        run: |
          $env:PATH += ";C:\Program Files (x86)\NSIS"
          makensis setup.nsi
          if (!(Test-Path "popdam-windows-agent-setup.exe")) {
            Write-Error "Installer was not created"
            exit 1
          }
          Write-Host "Installer built successfully: $((Get-Item 'popdam-windows-agent-setup.exe').Length / 1MB) MB"

      - name: Read version from package.json
        id: version
        shell: bash
        run: |
          VERSION=$(node -p "require('./apps/windows-agent/package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Create dist.zip (for OTA updates)
        shell: powershell
        run: |
          Compress-Archive -Path "apps\windows-agent\dist\*" -DestinationPath "installer\popdam-windows-agent-dist.zip" -Force
          Write-Host "dist.zip created: $((Get-Item 'installer\popdam-windows-agent-dist.zip').Length / 1KB) KB"

      - name: Compute dist.zip checksum
        id: checksum
        shell: bash
        run: |
          SHA=$(sha256sum installer/popdam-windows-agent-dist.zip | cut -d' ' -f1)
          echo "sha256=$SHA" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA"

      - name: Create versioned GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: windows-agent-v${{ steps.version.outputs.version }}-${{ github.sha }}
          name: Windows Render Agent v${{ steps.version.outputs.version }}
          files: |
            installer/popdam-windows-agent-setup.exe
            installer/popdam-windows-agent-dist.zip
          generate_release_notes: false
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest release
        shell: bash
        run: |
          gh release delete windows-agent-latest --yes 2>/dev/null || true
          gh release create windows-agent-latest \
            installer/popdam-windows-agent-setup.exe \
            installer/popdam-windows-agent-dist.zip \
            --title "Windows Render Agent v${{ steps.version.outputs.version }} (Latest)" \
            --notes "Latest build of the PopDAM Windows Render Agent (Sharp + Ghostscript)." \
            --latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify cloud of new version
        shell: bash
        continue-on-error: true
        run: |
          DOWNLOAD_URL="https://github.com/u2giants/popdam3/releases/download/windows-agent-latest/popdam-windows-agent-dist.zip"
          INSTALLER_URL="https://github.com/u2giants/popdam3/releases/download/windows-agent-latest/popdam-windows-agent-setup.exe"
          curl -sS -X POST \
            "${{ secrets.SUPABASE_URL }}/functions/v1/agent-api" \
            -H "Content-Type: application/json" \
            -H "x-deploy-key: ${{ secrets.DEPLOY_WEBHOOK_KEY }}" \
            -d '{
              "action": "notify-build",
              "agent_type": "windows-render",
              "version": "${{ steps.version.outputs.version }}",
              "download_url": "'"$DOWNLOAD_URL"'",
              "installer_url": "'"$INSTALLER_URL"'",
              "checksum_sha256": "${{ steps.checksum.outputs.sha256 }}",
              "commit_sha": "${{ github.sha }}"
            }'
