name: Publish Windows Agent

on:
  push:
    branches: [main]
    paths:
      - "apps/windows-agent/**"
      - ".github/workflows/publish-windows-agent.yml"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: apps/windows-agent
        run: npm install

      - name: Build TypeScript
        working-directory: apps/windows-agent
        run: npm run build

      - name: Verify dist output exists
        working-directory: apps/windows-agent
        shell: powershell
        run: |
          if (!(Test-Path 'dist/index.js')) {
            Write-Error 'dist/index.js not found — TypeScript build failed'
            exit 1
          }
          Write-Host 'dist/index.js found, proceeding with packaging'

      - name: Download Node.js runtime for bundling
        shell: powershell
        run: |
          $nodeVersion = "v20.19.0"
          $nodeUrl = "https://nodejs.org/dist/$nodeVersion/node-v20.19.0-win-x64.zip"
          Invoke-WebRequest -Uri $nodeUrl -OutFile node-win.zip
          Expand-Archive node-win.zip -DestinationPath node-extracted
          Copy-Item "node-extracted\node-v20.19.0-win-x64\node.exe" -Destination "installer\node.exe"

      - name: Prepare distribution files
        working-directory: apps/windows-agent
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "..\..\installer\dist"
          Copy-Item -Recurse "dist\*" -Destination "..\..\installer\dist\"
          New-Item -ItemType Directory -Force -Path "..\..\installer\node_modules"
          Copy-Item -Recurse "node_modules\*" -Destination "..\..\installer\node_modules\"
          Copy-Item "package.json" -Destination "..\..\installer\"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-agent-dist
          path: |
            installer/node.exe
            installer/dist/
            installer/node_modules/
            installer/package.json

  package-installer:
    runs-on: windows-latest
    needs: build
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-agent-dist
          path: installer/

      - name: Install NSIS
        run: choco install nsis -y --no-progress

      - name: Install NSSM
        shell: powershell
        run: |
          choco install nssm -y --no-progress
          $realNssm = "C:\ProgramData\chocolatey\lib\NSSM\tools\nssm.exe"
          if (!(Test-Path $realNssm)) {
            $realNssm = Get-ChildItem "C:\ProgramData\chocolatey\lib\NSSM" -Recurse -Filter "nssm.exe" |
              Where-Object { $_.DirectoryName -notlike "*x86*" } |
              Select-Object -First 1 -ExpandProperty FullName
          }
          Write-Host "Real NSSM found at: $realNssm"
          $fileInfo = Get-Item $realNssm
          Write-Host "File size: $($fileInfo.Length) bytes"
          if ($fileInfo.Length -lt 100000) {
            throw "nssm.exe is too small - this is a shim, not the real exe"
          }
          Copy-Item $realNssm -Destination "installer\nssm.exe"

      - name: Create NSIS script
        shell: bash
        run: |
          cat > installer/setup.nsi << 'NSIS_EOF'
          !include "MUI2.nsh"
          !include "nsDialogs.nsh"
          !include "WordFunc.nsh"

          Name "PopDAM Windows Render Agent"
          OutFile "popdam-windows-agent-setup.exe"
          InstallDir "$PROGRAMFILES64\PopDAM\WindowsAgent"
          RequestExecutionLevel admin

          Var BootstrapToken
          Var TokenDialog
          Var TokenLabel
          Var TokenInput
          Var TokenHelp
          Var UserInput
          Var PassInput
          Var WinUser
          Var WinPass

          !insertmacro MUI_PAGE_DIRECTORY
          Page custom TokenPageCreate TokenPageLeave
          !insertmacro MUI_PAGE_INSTFILES
          !define MUI_FINISHPAGE_TEXT "PopDAM Windows Render Agent has been installed and started as a Windows Service.$\r$\n$\r$\nIt will automatically authenticate using your install token and receive its full configuration from PopDAM cloud settings. The agent should appear as Online in PopDAM Settings → Windows Agent within 60 seconds."
          !insertmacro MUI_PAGE_FINISH

          !insertmacro MUI_UNPAGE_CONFIRM
          !insertmacro MUI_UNPAGE_INSTFILES

          !insertmacro MUI_LANGUAGE "English"

          Function TokenPageCreate
            nsDialogs::Create 1018
            Pop $TokenDialog

            ${NSD_CreateLabel} 0 0 100% 24u "PopDAM Install Token"
            Pop $TokenLabel
            SendMessage $TokenLabel ${WM_SETFONT} 0 0

            ${NSD_CreateText} 0 30u 100% 16u ""
            Pop $TokenInput
            ${NSD_SetText} $TokenInput ""
            SendMessage $TokenInput ${EM_SETCUEBANNER} 1 "STR:XXXX-XXXX-XXXX-XXXX"

            ${NSD_CreateLabel} 0 54u 100% 20u "Generate this token in PopDAM Settings → Windows Agent.$\r$\nIt expires in 5 minutes and can only be used once."
            Pop $TokenHelp

            ${NSD_CreateLabel} 0 80u 100% 12u "Windows Username (for NAS access)"
            Pop $0
            ${NSD_CreateText} 0 94u 100% 14u "$USERNAME"
            Pop $UserInput

            ${NSD_CreateLabel} 0 112u 100% 12u "Windows Password"
            Pop $0
            ${NSD_CreatePassword} 0 126u 100% 14u ""
            Pop $PassInput

            ${NSD_CreateLabel} 0 146u 100% 20u "Enter your Windows login credentials so the agent can access network shares on your NAS."
            Pop $0

            nsDialogs::Show
          FunctionEnd

          Function TokenPageLeave
            ${NSD_GetText} $TokenInput $BootstrapToken
            StrCmp $BootstrapToken "" 0 +3
              MessageBox MB_OK|MB_ICONEXCLAMATION "Please enter the install token from PopDAM Settings."
              Abort
            ${NSD_GetText} $UserInput $WinUser
            ${NSD_GetText} $PassInput $WinPass
          FunctionEnd

          Section "Install"
            ; Handle reinstall cleanly
            IfFileExists "$INSTDIR\uninstall.exe" 0 +4
              MessageBox MB_YESNO "PopDAM Windows Render Agent is already installed. Uninstall the existing version first?" IDNO +2
              ExecWait '"$INSTDIR\uninstall.exe" /S'
              Sleep 3000

            SetOutPath "$INSTDIR"
            File "node.exe"
            File "package.json"
            File "nssm.exe"
            SetOutPath "$INSTDIR\dist"
            File /r "dist\*.*"
            SetOutPath "$INSTDIR\node_modules"
            File /r "node_modules\*.*"
            SetOutPath "$INSTDIR"

            ; Write .env with hardcoded Supabase URL and bootstrap token
            FileOpen $0 "$INSTDIR\.env" w
            FileWrite $0 "SUPABASE_URL=https://vklanxwmaeqjbwtmnygj.supabase.co$\r$\n"
            FileWrite $0 "BOOTSTRAP_TOKEN=$BootstrapToken$\r$\n"
            FileWrite $0 "AGENT_NAME=windows-render-agent$\r$\n"
            FileWrite $0 "# AGENT_KEY is written automatically on first startup$\r$\n"
            FileClose $0

            ; Remove existing service if present
            ExecWait '"$INSTDIR\nssm.exe" stop PopDAMWindowsAgent'
            ExecWait '"$INSTDIR\nssm.exe" remove PopDAMWindowsAgent confirm'
            Sleep 2000

            ; Install via nssm
            ExecWait '"$INSTDIR\nssm.exe" install PopDAMWindowsAgent "$INSTDIR\node.exe"' $0
            IntCmp $0 0 +3
              MessageBox MB_OK|MB_ICONEXCLAMATION "Failed to register Windows Service (error $0). Try running the installer as Administrator."
              Abort
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent AppParameters "dist\index.js"'
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent AppDirectory "$INSTDIR"'
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent DisplayName "PopDAM Windows Render Agent"'
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent Description "PopDAM Windows Render Agent (Ghostscript + Sharp thumbnail renderer)"'
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent Start SERVICE_AUTO_START'

            ; Create logs directory before configuring log paths
            CreateDirectory "$INSTDIR\logs"

            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent AppStdout "$INSTDIR\logs\agent.log"'
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent AppStderr "$INSTDIR\logs\agent-error.log"'
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent AppRotateFiles 1'
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent AppRotateSeconds 86400'
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent AppRotateBytes 10485760'

            ; Set service to run as specified Windows user (for NAS access)
            StrCmp $WinUser "" skip_objectname
              ; Check if username contains backslash (DOMAIN\user format)
              ${WordFind} $WinUser "\" "E+1{" $0
              IfErrors no_domain has_domain
              no_domain:
                StrCpy $3 ".\$WinUser"
                Goto set_objectname
              has_domain:
                StrCpy $3 $WinUser
              set_objectname:
              ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent ObjectName "$3" "$WinPass"'
            skip_objectname:

            ; Start the service
            ExecWait '"$INSTDIR\nssm.exe" start PopDAMWindowsAgent'

            ; Start Menu shortcuts
            CreateDirectory "$SMPROGRAMS\PopDAM"
            CreateShortcut "$SMPROGRAMS\PopDAM\PopDAM Windows Agent.lnk" "$INSTDIR\node.exe" "dist\index.js"
            CreateShortcut "$SMPROGRAMS\PopDAM\Uninstall Windows Agent.lnk" "$INSTDIR\uninstall.exe"

            ; Create uninstaller
            WriteUninstaller "$INSTDIR\uninstall.exe"

            ; Register in Add/Remove Programs
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "DisplayName" "PopDAM Windows Render Agent"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "UninstallString" '"$INSTDIR\uninstall.exe"'
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "QuietUninstallString" '"$INSTDIR\uninstall.exe" /S'
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "InstallLocation" "$INSTDIR"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "DisplayVersion" "1.0.0"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "Publisher" "PopDAM"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "DisplayIcon" "$INSTDIR\node.exe"
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "NoModify" 1
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "NoRepair" 1
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "EstimatedSize" 80000
          SectionEnd

          Section "Uninstall"
            ; Stop and remove service via nssm
            ExecWait '"$INSTDIR\nssm.exe" stop PopDAMWindowsAgent'
            Sleep 2000
            ExecWait '"$INSTDIR\nssm.exe" remove PopDAMWindowsAgent confirm'

            ; Remove installed files
            Delete "$INSTDIR\node.exe"
            Delete "$INSTDIR\package.json"
            Delete "$INSTDIR\nssm.exe"
            Delete "$INSTDIR\.env"
            Delete "$INSTDIR\agent-key.cfg"
            Delete "$INSTDIR\.env.example"
            Delete "$INSTDIR\uninstall.exe"
            RMDir /r "$INSTDIR\dist"
            RMDir /r "$INSTDIR\node_modules"
            RMDir /r "$INSTDIR\logs"

            ; Remove directories if empty
            RMDir "$INSTDIR"
            RMDir "$PROGRAMFILES64\PopDAM"

            ; Remove Start Menu shortcuts
            RMDir /r "$SMPROGRAMS\PopDAM"

            ; Remove registry uninstall entry
            DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent"
          SectionEnd
          NSIS_EOF

      - name: Build installer
        run: |
          $env:PATH += ";C:/Program Files (x86)/NSIS"
          makensis installer/setup.nsi
        shell: powershell

      - name: Create versioned GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: windows-agent-${{ github.sha }}
          name: Windows Render Agent (${{ github.sha }})
          files: installer/popdam-windows-agent-setup.exe
          generate_release_notes: false
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest release
        run: |
          gh release delete windows-agent-latest --yes 2>$null
          gh release create windows-agent-latest installer/popdam-windows-agent-setup.exe --title "Windows Render Agent (Latest)" --notes "Latest build of the PopDAM Windows Render Agent" --latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
