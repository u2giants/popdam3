name: Publish Windows Agent

on:
  push:
    branches: [main]
    paths:
      - "apps/windows-agent/**"
      - ".github/workflows/publish-windows-agent.yml"

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: apps/windows-agent
        run: npm install

      - name: Build TypeScript
        working-directory: apps/windows-agent
        run: npm run build

      - name: Verify dist output exists
        working-directory: apps/windows-agent
        shell: powershell
        run: |
          if (!(Test-Path 'dist/index.js')) {
            Write-Error 'dist/index.js not found — TypeScript build failed'
            exit 1
          }
          Write-Host 'dist/index.js found, proceeding with packaging'

      - name: Install pkg
        run: npm install -g pkg

      - name: Bundle into Windows exe
        working-directory: apps/windows-agent
        run: pkg . --target node18-win-x64 --output popdam-windows-agent.exe --compress GZip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-agent-exe
          path: apps/windows-agent/popdam-windows-agent.exe

  package-installer:
    runs-on: windows-latest
    needs: build
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-agent-exe
          path: installer/

      - name: Install NSIS
        run: choco install nsis -y --no-progress

      - name: Install NSSM
        shell: powershell
        run: |
          choco install nssm -y --no-progress
          $nssmPath = (Get-Command nssm).Source
          Write-Host "NSSM installed at: $nssmPath"
          Copy-Item $nssmPath -Destination "installer\nssm.exe"

      - name: Create NSIS script
        shell: bash
        run: |
          cat > installer/setup.nsi << 'NSIS_EOF'
          !include "MUI2.nsh"
          !include "nsDialogs.nsh"

          Name "PopDAM Windows Render Agent"
          OutFile "popdam-windows-agent-setup.exe"
          InstallDir "$PROGRAMFILES64\PopDAM\WindowsAgent"
          RequestExecutionLevel admin

          Var BootstrapToken
          Var TokenDialog
          Var TokenLabel
          Var TokenInput
          Var TokenHelp

          !insertmacro MUI_PAGE_DIRECTORY
          Page custom TokenPageCreate TokenPageLeave
          !insertmacro MUI_PAGE_INSTFILES
          !define MUI_FINISHPAGE_TEXT "PopDAM Windows Render Agent has been installed and started as a Windows Service.$\r$\n$\r$\nIt will automatically authenticate using your install token and receive its full configuration from PopDAM cloud settings. The agent should appear as Online in PopDAM Settings → Windows Agent within 60 seconds."
          !insertmacro MUI_PAGE_FINISH

          !insertmacro MUI_UNPAGE_CONFIRM
          !insertmacro MUI_UNPAGE_INSTFILES

          !insertmacro MUI_LANGUAGE "English"

          Function TokenPageCreate
            nsDialogs::Create 1018
            Pop $TokenDialog

            ${NSD_CreateLabel} 0 0 100% 24u "PopDAM Install Token"
            Pop $TokenLabel
            SendMessage $TokenLabel ${WM_SETFONT} 0 0

            ${NSD_CreateText} 0 30u 100% 16u ""
            Pop $TokenInput
            ${NSD_SetText} $TokenInput ""
            SendMessage $TokenInput ${EM_SETCUEBANNER} 1 "STR:XXXX-XXXX-XXXX-XXXX"

            ${NSD_CreateLabel} 0 54u 100% 32u "Generate this token in PopDAM Settings → Windows Agent.$\r$\nIt expires in 5 minutes and can only be used once."
            Pop $TokenHelp

            nsDialogs::Show
          FunctionEnd

          Function TokenPageLeave
            ${NSD_GetText} $TokenInput $BootstrapToken
            StrCmp $BootstrapToken "" 0 +3
              MessageBox MB_OK|MB_ICONEXCLAMATION "Please enter the install token from PopDAM Settings."
              Abort
          FunctionEnd

          Section "Install"
            ; Handle reinstall cleanly
            IfFileExists "$INSTDIR\uninstall.exe" 0 +4
              MessageBox MB_YESNO "PopDAM Windows Render Agent is already installed. Uninstall the existing version first?" IDNO +2
              ExecWait '"$INSTDIR\uninstall.exe" /S'
              Sleep 3000

            SetOutPath "$INSTDIR"
            File "popdam-windows-agent.exe"
            File "nssm.exe"

            ; Write .env with hardcoded Supabase URL and bootstrap token
            FileOpen $0 "$INSTDIR\.env" w
            FileWrite $0 "SUPABASE_URL=https://vklanxwmaeqjbwtmnygj.supabase.co$\r$\n"
            FileWrite $0 "BOOTSTRAP_TOKEN=$BootstrapToken$\r$\n"
            FileWrite $0 "AGENT_NAME=windows-render-agent$\r$\n"
            FileWrite $0 "# AGENT_KEY is written automatically on first startup$\r$\n"
            FileClose $0

            ; Remove existing service if present
            ExecWait '"$INSTDIR\nssm.exe" stop PopDAMWindowsAgent'
            ExecWait '"$INSTDIR\nssm.exe" remove PopDAMWindowsAgent confirm'
            Sleep 2000

            ; Install via nssm
            ExecWait '"$INSTDIR\nssm.exe" install PopDAMWindowsAgent "$INSTDIR\popdam-windows-agent.exe"' $0
            IntCmp $0 0 +3
              MessageBox MB_OK|MB_ICONEXCLAMATION "Failed to register Windows Service (error $0). Try running the installer as Administrator."
              Abort
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent AppDirectory "$INSTDIR"'
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent DisplayName "PopDAM Windows Render Agent"'
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent Description "Renders AI files using Adobe Illustrator for PopDAM"'
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent Start SERVICE_AUTO_START'

            ; Create logs directory before configuring log paths
            CreateDirectory "$INSTDIR\logs"

            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent AppStdout "$INSTDIR\logs\agent.log"'
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent AppStderr "$INSTDIR\logs\agent-error.log"'
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent AppRotateFiles 1'
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent AppRotateSeconds 86400'
            ExecWait '"$INSTDIR\nssm.exe" set PopDAMWindowsAgent AppRotateBytes 10485760'

            ; Start the service
            ExecWait '"$INSTDIR\nssm.exe" start PopDAMWindowsAgent'

            ; Start Menu shortcuts
            CreateDirectory "$SMPROGRAMS\PopDAM"
            CreateShortcut "$SMPROGRAMS\PopDAM\PopDAM Windows Agent.lnk" "$INSTDIR\popdam-windows-agent.exe"
            CreateShortcut "$SMPROGRAMS\PopDAM\Uninstall Windows Agent.lnk" "$INSTDIR\uninstall.exe"

            ; Create uninstaller
            WriteUninstaller "$INSTDIR\uninstall.exe"

            ; Register in Add/Remove Programs
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "DisplayName" "PopDAM Windows Render Agent"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "UninstallString" '"$INSTDIR\uninstall.exe"'
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "QuietUninstallString" '"$INSTDIR\uninstall.exe" /S'
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "InstallLocation" "$INSTDIR"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "DisplayVersion" "1.0.0"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "Publisher" "PopDAM"
            WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "DisplayIcon" "$INSTDIR\popdam-windows-agent.exe"
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "NoModify" 1
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "NoRepair" 1
            WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent" "EstimatedSize" 60000
          SectionEnd

          Section "Uninstall"
            ; Stop and remove service via nssm
            ExecWait '"$INSTDIR\nssm.exe" stop PopDAMWindowsAgent'
            Sleep 2000
            ExecWait '"$INSTDIR\nssm.exe" remove PopDAMWindowsAgent confirm'

            ; Remove installed files
            Delete "$INSTDIR\popdam-windows-agent.exe"
            Delete "$INSTDIR\nssm.exe"
            Delete "$INSTDIR\.env"
            Delete "$INSTDIR\agent-key.cfg"
            Delete "$INSTDIR\.env.example"
            Delete "$INSTDIR\uninstall.exe"
            RMDir /r "$INSTDIR\logs"

            ; Remove directories if empty
            RMDir "$INSTDIR"
            RMDir "$PROGRAMFILES64\PopDAM"

            ; Remove Start Menu shortcuts
            RMDir /r "$SMPROGRAMS\PopDAM"

            ; Remove registry uninstall entry
            DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\PopDAMWindowsAgent"
          SectionEnd
          NSIS_EOF

      - name: Build installer
        run: |
          $env:PATH += ";C:/Program Files (x86)/NSIS"
          makensis installer/setup.nsi
        shell: powershell

      - name: Create versioned GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: windows-agent-${{ github.sha }}
          name: Windows Render Agent (${{ github.sha }})
          files: installer/popdam-windows-agent-setup.exe
          generate_release_notes: false
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update latest release
        run: |
          gh release delete windows-agent-latest --yes 2>$null
          gh release create windows-agent-latest installer/popdam-windows-agent-setup.exe --title "Windows Render Agent (Latest)" --notes "Latest build of the PopDAM Windows Render Agent" --latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
